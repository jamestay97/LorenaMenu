<script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://domtvkfulaimxsbyvryd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvbXR2a2Z1bGFpbXhzYnl2cnlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMDEzNjQsImV4cCI6MjA4MTY3NzM2NH0.gtVE1bOIQIzmQSJjOjR6WbPoILyGCylwjm9nuUXmjzA';
    
    // FIXED: Use 'window.supabase' to create the client and name it 'sb'
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- INITIALIZATION ---
    window.onload = async () => {
      // Check if user is logged in
      const { data: { session } } = await sb.auth.getSession();
      
      if (session) {
        // Logged in: Show Admin
        toggleView('view-admin');
        loadAdminData();
      } else {
        // Not logged in: Show Public
        toggleView('view-public');
        loadPublicData();
      }
    };

    // --- PUBLIC LOGIC ---
    async function loadPublicData() {
      const params = new URLSearchParams(window.location.search);
      const archiveId = params.get('id');
      let menu = null;

      if (archiveId) {
        // Fetch specific past menu
        const { data } = await sb.from('menus').select('*').eq('id', archiveId).single();
        menu = data;
        if(menu) document.getElementById('expired-notice').style.display = 'block';
      } else {
        // Fetch current active menu
        const { data } = await sb.from('menus').select('*').eq('is_active', true).limit(1).single();
        menu = data;
      }

      // Render Menu
      if (menu) {
        document.getElementById('week-display').textContent = menu.week_label;
        const d = menu.menu_data;
        document.getElementById('menu-grid-container').innerHTML = `
          <div class="meal-card">
            <span class="meal-number">Option 01</span>
            <h3 class="meal-title">${d.m1_main}</h3>
            <p class="meal-side">${d.m1_side}</p>
          </div>
          <div class="meal-card">
            <span class="meal-number">Option 02</span>
            <h3 class="meal-title">${d.m2_main}</h3>
            <p class="meal-side">${d.m2_side}</p>
          </div>
          <div class="meal-card">
            <span class="meal-number">Option 03</span>
            <h3 class="meal-title">${d.m3_main}</h3>
            <p class="meal-side">${d.m3_side}</p>
          </div>
        `;
      } else {
        document.getElementById('week-display').style.display = 'none';
        document.getElementById('menu-grid-container').innerHTML = `<div style="text-align:center; grid-column:1/-1;">No active menu found.</div>`;
      }

      // Load Archive History
      const { data: history } = await sb.from('menus').select('id, week_label').eq('is_active', false).order('created_at', { ascending: false });
      const list = document.getElementById('archive-list');
      if(history && history.length) {
        list.innerHTML = history.map(m => `<a href="?id=${m.id}" class="archive-link">${m.week_label}</a>`).join('');
      } else {
        list.innerHTML = `<div style="text-align:center; color:#ccc; font-size:12px;">No past menus yet.</div>`;
      }
    }

    // --- ADMIN LOGIC ---
    async function loadAdminData() {
      const { data: recipes } = await sb.from('recipes').select('*');
      const mList = document.getElementById('list-mains');
      const sList = document.getElementById('list-sides');
      mList.innerHTML = ''; sList.innerHTML = '';
      if (recipes) recipes.forEach(r => {
        const opt = document.createElement('option'); opt.value = r.name;
        if(r.category === 'main') mList.appendChild(opt);
        if(r.category === 'side') sList.appendChild(opt);
      });
    }

    async function saveMenu() {
      const weekLabel = document.getElementById('edit-week').value;
      const m1_main = document.getElementById('m1-main').value; const m1_side = document.getElementById('m1-side').value;
      const m2_main = document.getElementById('m2-main').value; const m2_side = document.getElementById('m2-side').value;
      const m3_main = document.getElementById('m3-main').value; const m3_side = document.getElementById('m3-side').value;

      if (!weekLabel || !m1_main) return alert("Please fill out the menu.");
      
      const btn = document.querySelector('.btn');
      btn.textContent = "Publishing...";
      btn.disabled = true;

      // Deactivate old menus
      await sb.from('menus').update({ is_active: false }).eq('is_active', true);
      
      // Helper to save recipes
      const saveR = async (n, c) => {
        if(!n) return;
        const { data } = await sb.from('recipes').select('id').eq('name', n).single();
        if(!data) await sb.from('recipes').insert({ name: n, category: c });
      };

      // Save all inputs to recipe library
      await saveR(m1_main, 'main'); await saveR(m1_side, 'side');
      await saveR(m2_main, 'main'); await saveR(m2_side, 'side');
      await saveR(m3_main, 'main'); await saveR(m3_side, 'side');

      // Insert new menu
      const { error } = await sb.from('menus').insert({
        week_label: weekLabel, is_active: true,
        menu_data: { m1_main, m1_side, m2_main, m2_side, m3_main, m3_side }
      });

      if(error) { 
        alert(error.message); 
        btn.textContent = "Publish Live Menu"; 
        btn.disabled = false; 
      } else { 
        location.reload(); 
      }
    }

    // --- AUTH LOGIC ---
    function showLogin() { toggleView('view-login'); }
    function showPublic() { toggleView('view-public'); }
    
    function toggleView(id) {
      ['view-login', 'view-public', 'view-admin'].forEach(v => {
        document.getElementById(v).style.display = (v === id ? (v==='view-login'?'flex':'block') : 'none');
      });
    }

    async function handleLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) alert(error.message); 
      else location.reload();
    }

    async function handleLogout() { 
      await sb.auth.signOut(); 
      location.reload(); 
    }
  </script>
